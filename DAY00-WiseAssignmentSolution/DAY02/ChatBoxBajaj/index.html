<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beautiful Live Chat</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --accent: #7c3aed;
      --muted: #94a3b8;
      --me: #0ea5a4;
      --glass: rgba(255,255,255,0.03);
    }
    html,body { height:100%; margin:0; font-family: Inter, Arial, sans-serif; background: linear-gradient(135deg,#071127 0%, #0b1220 100%); color:#e6eef8; }
    .app { max-width:1000px; margin:40px auto; display:flex; gap:20px; padding:18px; }
    .sidebar {
      width:260px; background:var(--card); border-radius:12px; padding:16px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    }
    .main {
      flex:1; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; display:flex; flex-direction:column;
      min-height: 480px;
    }
    h2 { margin:0 0 12px 0; font-size:18px; }
    .profile {
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .avatar {
      width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#06b6d4);
      display:flex; align-items:center; justify-content:center; font-weight:700; color:white; font-size:18px;
      box-shadow: 0 6px 20px rgba(124,58,237,0.18);
    }
    .small { color:var(--muted); font-size:13px; }

    .usersList { margin-top:16px; }
    .userItem { display:flex; justify-content:space-between; padding:8px 6px; border-radius:8px; align-items:center; gap:8px; }
    .userItem:hover { background: rgba(255,255,255,0.02); }

    .chatWindow { flex:1; overflow:auto; padding-right:8px; margin-bottom:12px; }
    .message { margin:10px 0; display:flex; gap:12px; align-items:flex-end; }
    .bubble { max-width:70%; padding:10px 12px; border-radius:12px; background:var(--glass); color: #e6eef8; font-size:14px; }
    .bubble.me { background: linear-gradient(90deg, rgba(14,165,164,0.15), rgba(124,58,237,0.12)); box-shadow: 0 6px 20px rgba(14,165,164,0.06); align-self:flex-end; }
    .meta { font-size:12px; color:var(--muted); margin-top:6px; }
    .toolbar { display:flex; gap:8px; align-items:center; }

    .inputRow { display:flex; gap:8px; align-items:center; margin-top:8px; }
    input[type="text"] { flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; font-size:14px; }
    button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(90deg,var(--accent),#06b6d4); color:white; }

    .sys { opacity:0.8; color: var(--muted); text-align:center; margin:8px 0; font-size:13px; }

    .topBar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
    .title { font-size:20px; font-weight:700; }
    .sub { font-size:13px; color:var(--muted); }

    @media (max-width:900px) {
      .app { flex-direction:column; padding:12px; }
      .sidebar { width:100%; order:2; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="main">
      <div class="topBar">
        <div>
          <div class="title">Live Chat</div>
          <div class="sub">Real-time messages (WebSocket)</div>
        </div>
        <div id="meInfo" class="small">Not logged</div>
      </div>

      <div id="chatWindow" class="chatWindow" aria-live="polite"></div>

      <div class="inputRow">
        <input id="messageInput" type="text" placeholder="Type your message..." autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
    </div>

    <div class="sidebar">
      <div class="profile">
        <div class="avatar" id="avatar">Y</div>
        <div>
          <div id="nameDisplay" style="font-weight:700">Guest</div>
          <div class="small">Your identity in chat</div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <button id="changeNameBtn" style="width:100%; padding:8px; border-radius:8px; border:none; cursor:pointer;">Change Name</button>
      </div>

      <div class="usersList" id="usersList">
        <h2 style="margin-top:16px;">Connected</h2>
        <!-- user items will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Connect to websocket on same origin and port
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = protocol + '://' + location.host;
    const ws = new WebSocket(wsUrl);

    // UI references
    const chatWindow = document.getElementById('chatWindow');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const nameDisplay = document.getElementById('nameDisplay');
    const avatar = document.getElementById('avatar');
    const meInfo = document.getElementById('meInfo');
    const usersList = document.getElementById('usersList');
    const changeNameBtn = document.getElementById('changeNameBtn');

    // Load username from localStorage (if present) else prompt
    function askForName(defaultName = '') {
      const stored = localStorage.getItem('chat_username') || defaultName;
      let name = stored;
      while (!name) {
        name = prompt('Enter your name for chat:', defaultName || 'yash') || '';
        name = name.trim().slice(0, 32);
      }
      localStorage.setItem('chat_username', name);
      return name;
    }

    let myName = localStorage.getItem('chat_username') || '';
    if (!myName) {
      myName = askForName('yash'); // prompt default yash as user requested
    }

    // reflect UI
    function setMyNameUI(name) {
      nameDisplay.textContent = name;
      avatar.textContent = name[0] ? name[0].toUpperCase() : 'G';
      meInfo.textContent = 'You: ' + name;
    }
    setMyNameUI(myName);

    // Send login when ws opens
    ws.addEventListener('open', () => {
      send({ type: 'login', username: myName });
    });

    // Helper for sending JSON objects to server
    function send(obj) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(obj));
      } else {
        console.warn('WS not open yet', obj);
      }
    }

    // Render helpers
    function appendSystem(text) {
      const el = document.createElement('div');
      el.className = 'sys';
      el.textContent = text;
      chatWindow.appendChild(el);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendMessage({ from, text, ts }, me=false) {
      const wrapper = document.createElement('div');
      wrapper.className = 'message';

      const bubble = document.createElement('div');
      bubble.className = 'bubble' + (me ? ' me' : '');

      bubble.innerHTML = `<strong>${me ? 'You' : from}</strong><div style="margin-top:6px;">${escapeHtml(text)}</div><div class="meta">${new Date(ts).toLocaleTimeString()}</div>`;
      wrapper.appendChild(bubble);
      chatWindow.appendChild(wrapper);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function renderUsers(users) {
      // users = [{username, id}, ...]
      const container = document.createElement('div');
      users.forEach(u => {
        const item = document.createElement('div');
        item.className = 'userItem';
        item.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04);font-weight:600">${escapeHtml(u.username[0]||'G')}</div><div><div style="font-weight:700">${escapeHtml(u.username)}</div><div class="small">id: ${u.id}</div></div></div>`;
        container.appendChild(item);
      });

      // replace usersList content except the heading
      const heading = usersList.querySelector('h2');
      usersList.innerHTML = '';
      usersList.appendChild(heading);
      usersList.appendChild(container);
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Handle incoming messages
    ws.addEventListener('message', (ev) => {
      let data;
      try {
        data = JSON.parse(ev.data);
      } catch (e) {
        console.warn('bad json', ev.data);
        return;
      }

      if (data.type === 'welcome') {
        // optional: server gave an id
        // ignore for now
      } else if (data.type === 'loggedin') {
        appendSystem(`You are logged in as ${data.username}`);
      } else if (data.type === 'system') {
        appendSystem(data.text);
      } else if (data.type === 'message') {
        const amI = data.from === myName;
        appendMessage(data, amI);
      } else if (data.type === 'users') {
        renderUsers(data.users);
      }
    });

    // Send message on button click or Enter
    sendBtn.addEventListener('click', () => {
      const text = messageInput.value.trim();
      if (!text) return;
      const obj = { type: 'message', text };
      send(obj);
      // show locally immediately
      appendMessage({ from: myName, text, ts: Date.now() }, true);
      messageInput.value = '';
      messageInput.focus();
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Allow changing name
    changeNameBtn.addEventListener('click', () => {
      const newName = prompt('Enter new display name:', myName) || '';
      const trimmed = newName.trim().slice(0,32);
      if (trimmed && trimmed !== myName) {
        myName = trimmed;
        localStorage.setItem('chat_username', myName);
        setMyNameUI(myName);
        // notify server of new name by re-login
        send({ type: 'login', username: myName });
      }
    });

    // gracefully handle socket close
    ws.addEventListener('close', () => appendSystem('Disconnected from server'));
    ws.addEventListener('error', () => appendSystem('Connection error'));
  </script>
</body>
</html>
